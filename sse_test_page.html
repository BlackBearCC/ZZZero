<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SSEåŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .checkbox-group { border: 1px solid #ddd; padding: 15px; border-radius: 4px; }
        .checkbox-item { margin: 5px 0; }
        #output { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; min-height: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ è§’è‰²èµ„æ–™ç”Ÿæˆ SSE æµ‹è¯•</h1>
        
        <form id="characterForm">
            <div class="form-group">
                <label for="character_name">è§’è‰²åç§°:</label>
                <input type="text" id="character_name" value="æµ‹è¯•è§’è‰²" required>
            </div>
            
            <div class="form-group">
                <label for="basic_info">åŸºç¡€äººè®¾:</label>
                <textarea id="basic_info" rows="4" required>ä¸€ä¸ªç”¨äºæµ‹è¯•çš„è§’è‰²ï¼Œæ€§æ ¼å¼€æœ—æ´»æ³¼ï¼Œå–œæ¬¢æ¢é™©å’Œå­¦ä¹ æ–°äº‹ç‰©ã€‚</textarea>
            </div>
            
            <div class="form-group">
                <label>é€‰æ‹©ç”Ÿæˆç±»åˆ«:</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat1" value="åŸºæœ¬ä¿¡æ¯" checked>
                        <label for="cat1">åŸºæœ¬ä¿¡æ¯</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat2" value="æ€§æ ¼ç‰¹å¾" checked>
                        <label for="cat2">æ€§æ ¼ç‰¹å¾</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat3" value="å¤–è²Œç‰¹å¾">
                        <label for="cat3">å¤–è²Œç‰¹å¾</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="llm_provider">LLMæä¾›å•†:</label>
                <select id="llm_provider">
                    <option value="doubao" selected>è±†åŒ…</option>
                    <option value="openai">OpenAI</option>
                </select>
            </div>
            
            <button type="button" onclick="startSSEWorkflow()">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
            <button type="button" onclick="clearOutput()">ğŸ§¹ æ¸…ç©ºè¾“å‡º</button>
        </form>
        
        <div id="output">
            <h3>æ‰§è¡Œæ—¥å¿—:</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let sessionId = null;

        function addMessage(sender, content, type = 'normal') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.style.margin = '8px 0';
            messageDiv.style.padding = '8px';
            messageDiv.style.borderRadius = '4px';
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            switch(type) {
                case 'error':
                    messageDiv.style.background = '#ffebee';
                    messageDiv.style.color = '#c62828';
                    break;
                case 'success':
                    messageDiv.style.background = '#e8f5e8';
                    messageDiv.style.color = '#2e7d32';
                    break;
                case 'streaming':
                    messageDiv.style.background = '#fff3e0';
                    messageDiv.style.color = '#ef6c00';
                    break;
                default:
                    messageDiv.style.background = '#e3f2fd';
                    messageDiv.style.color = '#1976d2';
            }
            
            messageDiv.innerHTML = `<strong>[${sender}]</strong> ${content}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function startSSEWorkflow() {
            try {
                // è·å–è¡¨å•æ•°æ®
                const characterName = document.getElementById('character_name').value;
                const basicInfo = document.getElementById('basic_info').value;
                const llmProvider = document.getElementById('llm_provider').value;
                
                // è·å–é€‰ä¸­çš„ç±»åˆ«
                const selectedCategories = [];
                document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    selectedCategories.push(cb.value);
                });
                
                // è¾“å…¥éªŒè¯
                if (!characterName.trim()) {
                    alert('è¯·è¾“å…¥è§’è‰²åç§°');
                    return;
                }
                
                if (!basicInfo.trim()) {
                    alert('è¯·è¾“å…¥åŸºç¡€äººè®¾');
                    return;
                }
                
                if (selectedCategories.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç”Ÿæˆç±»åˆ«');
                    return;
                }
                
                addMessage('ç³»ç»Ÿ', 'æ­£åœ¨å¯åŠ¨å·¥ä½œæµ...', 'normal');
                
                // æ„å»ºå‚æ•°
                const params = {
                    character_name: characterName,
                    basic_info: basicInfo,
                    selected_categories: selectedCategories,
                    selected_collections: [],
                    llm_provider: llmProvider,
                    model_name: 'ep-20250221154410-vh78x',
                    temperature: 0.7
                };
                
                console.log('å¯åŠ¨å‚æ•°:', params);
                
                // å¯åŠ¨å·¥ä½œæµ
                const response = await fetch('http://127.0.0.1:5001/api/workflow/character_profile_stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const sessionData = await response.json();
                sessionId = sessionData.session_id;
                
                addMessage('ç³»ç»Ÿ', `ä¼šè¯åˆ›å»ºæˆåŠŸ: ${sessionId}`, 'success');
                
                // åˆ›å»ºSSEè¿æ¥
                eventSource = new EventSource(`http://127.0.0.1:5001/api/sse/stream/${sessionId}`);
                
                eventSource.onopen = () => {
                    addMessage('SSE', 'è¿æ¥å·²å»ºç«‹', 'success');
                };
                
                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleSSEEvent(data);
                    } catch (error) {
                        console.error('è§£æSSEæ•°æ®å¤±è´¥:', error);
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('SSEè¿æ¥é”™è¯¯:', error);
                    addMessage('SSE', 'è¿æ¥å‡ºç°é”™è¯¯', 'error');
                };
                
            } catch (error) {
                console.error('å¯åŠ¨å·¥ä½œæµå¤±è´¥:', error);
                addMessage('ç³»ç»Ÿ', `å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function handleSSEEvent(data) {
            const { type } = data;
            
            switch (type) {
                case 'message':
                    const messageData = data.data;
                    addMessage(messageData.sender, messageData.content, messageData.type || 'normal');
                    break;
                    
                case 'streaming_content':
                    addMessage(data.node, data.content, 'streaming');
                    break;
                    
                case 'status':
                    addMessage('çŠ¶æ€', data.status, 'normal');
                    break;
                    
                case 'complete':
                    addMessage('ç³»ç»Ÿ', 'å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼', 'success');
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    break;
                    
                default:
                    console.log('æœªçŸ¥SSEäº‹ä»¶ç±»å‹:', type, data);
            }
        }

        function clearOutput() {
            document.getElementById('messages').innerHTML = '';
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                addMessage('ç³»ç»Ÿ', 'SSEè¿æ¥å·²å…³é—­', 'normal');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºçŠ¶æ€
        window.addEventListener('load', () => {
            addMessage('ç³»ç»Ÿ', 'SSEæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            addMessage('æç¤º', 'è¯·å¡«å†™è§’è‰²ä¿¡æ¯åç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"æµ‹è¯•SSEåŠŸèƒ½', 'normal');
        });
    </script>
</body>
</html>