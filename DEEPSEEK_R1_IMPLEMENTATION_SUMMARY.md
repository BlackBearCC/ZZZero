# DeepSeek R1 æ¨ç†åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡

ä¸ºè±†åŒ…LLMæ·»åŠ DeepSeek R1æ¨ç†åŠŸèƒ½ï¼Œæ”¯æŒåœ¨StreamReactAgentNodeä¸­ä½¿ç”¨ï¼Œå®ç°å¸¦æ¨ç†çš„ç‰ˆæœ¬ï¼Œå¹¶ä½¿ç”¨ç¯å¢ƒå˜é‡`DOUBAO_MODEL_DEEPSEEKR1`é…ç½®æ¨¡å‹ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. åŸºç¡€æ¶æ„æ‰©å±•

#### `src/llm/base.py` - åŸºç±»æ‰©å±•
- âœ… æ·»åŠ äº† `ThinkResult` æ•°æ®ç»“æ„
- âœ… åœ¨ `BaseLLMProvider` ä¸­æ·»åŠ äº† `think()` æŠ½è±¡æ–¹æ³•
- âœ… åœ¨ `BaseLLMProvider` ä¸­æ·»åŠ äº† `stream_think()` æŠ½è±¡æ–¹æ³•
- âœ… æä¾›äº†é»˜è®¤å®ç°ï¼Œç¡®ä¿å‘åå…¼å®¹æ€§

```python
class ThinkResult(NamedTuple):
    reasoning_content: str  # æ¨ç†è¿‡ç¨‹å†…å®¹
    content: str           # æœ€ç»ˆç­”æ¡ˆå†…å®¹
    metadata: Dict[str, Any]  # å…ƒæ•°æ®ä¿¡æ¯
```

#### `src/llm/doubao.py` - DoubaoLLMæ‰©å±•
- âœ… å®ç°äº† `think()` æ–¹æ³•ï¼Œæ”¯æŒDeepSeek R1æ¨ç†æ¨¡å‹
- âœ… å®ç°äº† `stream_think()` æ–¹æ³•ï¼Œæ”¯æŒæµå¼æ¨ç†è¾“å‡º
- âœ… æ”¯æŒç¯å¢ƒå˜é‡ `DOUBAO_MODEL_DEEPSEEKR1` é…ç½®æ¨¡å‹åç§°
- âœ… è‡ªåŠ¨è¿‡æ»¤DeepSeek R1ä¸æ”¯æŒçš„å‚æ•°ï¼ˆtop_pã€presence_penaltyç­‰ï¼‰
- âœ… ä½¿ç”¨æ¨èçš„æ¸©åº¦è®¾ç½®ï¼ˆ0.6ï¼‰å’Œæœ€å¤§tokené™åˆ¶ï¼ˆ32Kï¼‰

### 2. æµå¼ReActèŠ‚ç‚¹å¢å¼º

#### `src/nodes/stream_react_agent_node.py` - æ¨ç†é›†æˆ
- âœ… ä¿®æ”¹äº† `_stream_react_generation_with_depth()` æ–¹æ³•
- âœ… è‡ªåŠ¨æ£€æµ‹LLMæ˜¯å¦æ”¯æŒæ¨ç†åŠŸèƒ½ï¼ˆ`hasattr(self.llm, 'stream_think')`ï¼‰
- âœ… ä½¿ç”¨æ¨ç†æ¨¡å¼æ—¶ï¼Œåˆ†åˆ«å¤„ç†æ¨ç†è¿‡ç¨‹å’Œæœ€ç»ˆç­”æ¡ˆ
- âœ… ä¿æŒZZZeroå¤å¤æœºå™¨äººé£æ ¼çš„è¾“å‡ºæ ¼å¼
- âœ… å‘åå…¼å®¹ï¼šä¸æ”¯æŒæ¨ç†æ—¶è‡ªåŠ¨å›é€€åˆ°æ ‡å‡†ç”Ÿæˆ

#### æ¨ç†è¾“å‡ºæ ¼å¼
```python
# æ¨ç†è¿‡ç¨‹è¾“å‡º
{
    "type": "reasoning_chunk",
    "content": "*ZZZeroæ€è€ƒä¸­* {reasoning_chunk}",
    "accumulated": reasoning_content,
    "recursion_depth": recursion_depth
}

# æœ€ç»ˆç­”æ¡ˆè¾“å‡º
{
    "type": "text_chunk", 
    "content": content_chunk,
    "accumulated": accumulated_content,
    "recursion_depth": recursion_depth
}

# æ¨ç†æ€»ç»“
{
    "type": "reasoning_summary",
    "content": f"*ZZZeroæ¨ç†æ€»ç»“* ç»è¿‡ {len(final_reasoning)} å­—ç¬¦çš„æ·±åº¦æ€è€ƒ *zzz~*",
    "reasoning_length": len(final_reasoning),
    "recursion_depth": recursion_depth
}
```

### 3. æ™ºèƒ½ä»£ç†å¢å¼º

#### `src/agents/react_agent.py` - ReactAgentä¼˜åŒ–
- âœ… åœ¨ `_build_system_prompt()` ä¸­æ·»åŠ æ¨ç†åŠŸèƒ½æ£€æµ‹
- âœ… æ ¹æ®æ˜¯å¦æ”¯æŒæ¨ç†åŠŸèƒ½è°ƒæ•´ç³»ç»Ÿæç¤ºè¯
- âœ… ä¸ºæ¨ç†æ¨¡å¼æ·»åŠ ä¸“é—¨çš„æŒ‡å¯¼è§„åˆ™
- âœ… ä¿æŒè®°å¿†åŠŸèƒ½çš„å®Œæ•´å…¼å®¹æ€§

#### æ¨ç†å¢å¼ºæç¤ºè¯ç‰¹æ€§
- æ·±åº¦åˆ†æå¤æ‚é—®é¢˜çš„èƒ½åŠ›è¯´æ˜
- å¤šæ­¥éª¤é€»è¾‘æ¨å¯¼çš„æŒ‡å¯¼
- è‡ªæˆ‘éªŒè¯å’Œåæ€çš„è¦æ±‚
- å·¥å…·é€‰æ‹©å’Œä½¿ç”¨ç­–ç•¥çš„ä¼˜åŒ–å»ºè®®

### 4. ç¯å¢ƒé…ç½®æ”¯æŒ

#### ç¯å¢ƒå˜é‡é…ç½®
- âœ… `DOUBAO_MODEL_DEEPSEEKR1`: DeepSeek R1æ¨¡å‹åç§°ï¼ˆé»˜è®¤ï¼šdeepseek-reasonerï¼‰
- âœ… `ARK_API_KEY` / `DOUBAO_API_KEY`: APIå¯†é’¥
- âœ… `DOUBAO_BASE_URL`: APIåŸºç¡€URL
- âœ… è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®ï¼Œæä¾›åˆç†çš„é»˜è®¤å€¼

### 5. æµ‹è¯•å’ŒéªŒè¯

#### æµ‹è¯•è„šæœ¬
- âœ… `test_deepseek_r1_think.py`: å®Œæ•´çš„æ¨ç†åŠŸèƒ½æµ‹è¯•
- âœ… `test_think_integration.py`: ä»£ç ç»“æ„å’Œé›†æˆéªŒè¯
- âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥å’Œé…ç½®éªŒè¯
- âœ… é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µæµ‹è¯•

#### æ–‡æ¡£
- âœ… `DeepSeek_R1_Integration_README.md`: è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- âœ… APIä½¿ç”¨ç¤ºä¾‹å’Œé…ç½®æŒ‡å—
- âœ… æ€§èƒ½ä¼˜åŒ–å»ºè®®å’Œæ³¨æ„äº‹é¡¹

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

### 1. DeepSeek R1 APIé›†æˆ
- **æ¨ç†å†…å®¹åˆ†ç¦»**: æ”¯æŒ `reasoning_content` å’Œ `content` çš„åˆ†åˆ«å¤„ç†
- **æµå¼æ¨ç†**: å®æ—¶è¾“å‡ºæ¨ç†è¿‡ç¨‹å’Œæœ€ç»ˆç­”æ¡ˆ
- **å‚æ•°ä¼˜åŒ–**: è‡ªåŠ¨è¿‡æ»¤ä¸æ”¯æŒçš„å‚æ•°ï¼Œä½¿ç”¨æ¨èé…ç½®
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æŠ¥å‘Š

### 2. æ™ºèƒ½å…¼å®¹æ€§
- **è‡ªåŠ¨æ£€æµ‹**: è¿è¡Œæ—¶æ£€æµ‹LLMæ˜¯å¦æ”¯æŒæ¨ç†åŠŸèƒ½
- **ä¼˜é›…é™çº§**: ä¸æ”¯æŒæ¨ç†æ—¶è‡ªåŠ¨ä½¿ç”¨æ ‡å‡†ç”Ÿæˆ
- **å‘åå…¼å®¹**: ä¿æŒä¸ç°æœ‰ä»£ç çš„å®Œå…¨å…¼å®¹æ€§
- **æ¸è¿›å¢å¼º**: æ”¯æŒæ¨ç†æ—¶è‡ªåŠ¨å¯ç”¨å¢å¼ºåŠŸèƒ½

### 3. ZZZeroé£æ ¼é€‚é…
- **ä¸ªæ€§åŒ–è¾“å‡º**: ä¿æŒå¤å¤æœºå™¨äººçš„ç‹¬ç‰¹é£æ ¼
- **æ¨ç†å±•ç¤º**: ä»¥æœºå™¨äººå£å»å±•ç¤ºæ¨ç†è¿‡ç¨‹
- **æ™ºèƒ½åˆ†æ**: å¯¹æ¨ç†ç»“æœè¿›è¡ŒZZZeroé£æ ¼çš„åˆ†æ
- **äº¤äº’ä½“éªŒ**: æå‡ç”¨æˆ·çš„äº¤äº’ä½“éªŒ

## ğŸ“Š æ€§èƒ½å’Œç›‘æ§

### æ¨ç†ç»“æœå…ƒæ•°æ®
```python
{
    "model": "deepseek-reasoner",
    "has_reasoning": True,
    "reasoning_length": 1234,
    "content_length": 567,
    "finish_reason": "stop",
    "usage": {...}
}
```

### æµå¼è¾“å‡ºç±»å‹
- `reasoning_chunk`: æ¨ç†è¿‡ç¨‹ç‰‡æ®µ
- `content_chunk`: æœ€ç»ˆç­”æ¡ˆç‰‡æ®µ  
- `reasoning_summary`: æ¨ç†æ€»ç»“
- `think_complete`: æ¨ç†å®Œæˆä¿¡å·

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. åŸºç¡€æ¨ç†è°ƒç”¨
```python
from llm.doubao import DoubaoLLM

llm = DoubaoLLM(config)
result = await llm.think(messages)
print(f"æ¨ç†: {result.reasoning_content}")
print(f"ç­”æ¡ˆ: {result.content}")
```

### 2. æµå¼æ¨ç†è°ƒç”¨
```python
async for chunk in llm.stream_think(messages):
    if chunk["type"] == "reasoning_chunk":
        print(f"æ€è€ƒ: {chunk['content']}")
    elif chunk["type"] == "content_chunk":
        print(f"å›ç­”: {chunk['content']}")
```

### 3. StreamReactAgentNodeä½¿ç”¨
```python
# è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨æ¨ç†åŠŸèƒ½
node = StreamReactAgentNode("agent", llm, tool_manager)
async for chunk in node._stream_react_generation(messages):
    # å¤„ç†æ¨ç†å’Œå›ç­”è¾“å‡º
    pass
```

## ğŸ¯ å®ç°äº®ç‚¹

1. **å®Œå…¨å‘åå…¼å®¹**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯å—ç›Š
2. **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«å’Œä½¿ç”¨æ¨ç†åŠŸèƒ½
3. **ä¼˜é›…é™çº§**: ä¸æ”¯æŒæ¨ç†æ—¶çš„å¹³æ»‘ä½“éªŒ
4. **ZZZeroé£æ ¼**: ä¿æŒé¡¹ç›®çš„ç‹¬ç‰¹ä¸ªæ€§
5. **å®Œå–„æµ‹è¯•**: å…¨é¢çš„æµ‹è¯•è¦†ç›–å’ŒéªŒè¯
6. **è¯¦ç»†æ–‡æ¡£**: å®Œæ•´çš„ä½¿ç”¨æŒ‡å—å’Œé…ç½®è¯´æ˜

## ğŸ”® ä¸‹ä¸€æ­¥æ‰©å±•

1. **æ¨ç†æ¨¡å¼ä¼˜åŒ–**: æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æ¨ç†ç­–ç•¥
2. **æ¨ç†ç¼“å­˜**: ç¼“å­˜å¸¸è§æ¨ç†ç»“æœæå‡æ€§èƒ½
3. **æ¨ç†åˆ†æ**: åˆ†ææ¨ç†è´¨é‡å’Œæ•ˆæœ
4. **å¤šæ¨¡å‹æ”¯æŒ**: æ‰©å±•åˆ°å…¶ä»–æ¨ç†æ¨¡å‹
5. **æ¨ç†å¯è§†åŒ–**: æ›´ä¸°å¯Œçš„æ¨ç†è¿‡ç¨‹å±•ç¤º

---

**æ€»ç»“**: æˆåŠŸå®ç°äº†DeepSeek R1æ¨ç†åŠŸèƒ½çš„å®Œæ•´é›†æˆï¼Œä¸ºZZZeroæ™ºèƒ½ä»£ç†ç³»ç»Ÿæ·»åŠ äº†å¼ºå¤§çš„é€»è¾‘æ¨ç†èƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå…¼å®¹æ€§ã€‚ 