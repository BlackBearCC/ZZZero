# 新增多周期工作流功能

## 概述

我们为日程生成系统新增了多周期工作流功能，实现了更高质量的大规模日程生成。

## 核心改进

### 1. 周期规划节点 (CyclePlanningNode)
- **功能**: 预先规划整个时间段的所有周期
- **智能分配**: 自动将大时间段（如400天）分成多个周期，每个周期7-15天
- **规划内容**: 为每个周期制定主题、目标、重点角色、核心地点、关键事件

### 2. 分批渐进式生成 (ScheduleGenerateNode)
- **分批生成**: 每个周期内部再分成3天一批，分批生成提高质量
- **使用预规划**: 不再实时生成周期计划，而是使用预先规划的周期信息
- **历史连续性**: 自动获取前面周期的总结，保持故事连续性
- **批次总结**: 每3天生成一个阶段性总结

### 3. 工作流架构
```
1. 周期规划节点 → 2. 日程生成节点 → 3. 数据库保存节点
     ↓                    ↓                    ↓
   规划所有周期      分批渐进式生成         保存并合并数据
```

## 技术特性

### 智能周期分配
- 输入: 总天数（如400天）
- 输出: 多个周期（如28个周期，每个7-15天）
- 算法: 智能平衡周期长度，避免最后一个周期过短

### 分批生成机制
- 每个周期分成多个3天批次
- 每批次独立调用LLM，提高内容质量
- 批次间自动衔接，保持连贯性

### 历史总结系统
- 周期级别总结：每个周期完成后生成300字总结
- 批次级别总结：每3天生成200-300字阶段性总结
- 自动传递：下个周期/批次自动获取前面的总结作为上下文

## 使用示例

### 基本用法
```python
from batch_schedule_generator import BatchScheduleGenerator

# 创建生成器
generator = BatchScheduleGenerator(
    start_date='2025-07-20',
    batch_count=5  # 5个大批次
)

# 执行生成（自动支持多周期）
success_count, failed_count = await generator.generate_all_batches()
```

### 配置参数
```python
config = {
    'start_date': '2025-07-20',
    'end_date': '2025-08-30',  # 40天
    'total_days': 40,
    # 系统会自动分成约3-4个周期
    # 每个周期再分成多个3天批次
}
```

## 输出结果

### 数据结构
```python
batch_info = {
    'batch_number': 1,
    'cycles_count': 3,  # 包含3个周期
    'total_days': 40,
    'schedule_ids': ['SCHEDULE_001', 'SCHEDULE_002', 'SCHEDULE_003'],
    'cycle_summaries': ['周期1总结', '周期2总结', '周期3总结'],
    'daily_schedules': [...],  # 所有天的详细安排
    'characters': ['角色1', '角色2', ...],
    'locations': ['地点1', '地点2', ...]
}
```

### 文件输出
- **数据库**: 每个周期单独保存，支持查询和合并
- **CSV文件**: 增量追加到summary文件，便于分析
- **JSON文件**: 详细的批次数据（可选）

## 优势对比

### 旧版本
- 一次性生成整个时间段
- 无周期规划概念
- 质量随天数增加而下降
- 缺乏历史连续性

### 新版本
- 预先规划 + 分批渐进式生成
- 智能周期管理
- 每个小批次质量更高
- 完整的历史总结系统
- 支持大规模生成（数百天）

## 测试验证

运行测试脚本验证功能：
```bash
python test_new_workflow.py
```

预期输出包括：
- 周期规划信息
- 分批生成进度
- 周期总结生成
- 数据库保存确认
- 最终合并结果

## 注意事项

1. **内存使用**: 大规模生成时注意内存管理
2. **API限制**: 分批调用可能触发API限制，已添加间隔控制
3. **数据库性能**: 多周期保存对数据库有一定压力
4. **历史总结**: 确保数据库中有历史总结数据以获得最佳连续性

## 下一步改进

1. **并行生成**: 支持多个周期并行生成
2. **增量更新**: 支持对已生成周期的增量修改
3. **质量评估**: 自动评估生成质量并调整参数
4. **可视化界面**: 提供周期规划和进度的可视化界面 