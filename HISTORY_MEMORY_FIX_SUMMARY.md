# ZZZero App å†å²è®°å½•å’Œè®°å¿†ç³»ç»Ÿä¿®å¤æ€»ç»“

## é—®é¢˜è¯Šæ–­

é‡æ„åçš„app.pyå­˜åœ¨ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

1. **å†å²ä¸Šä¸‹æ–‡ä¸¢å¤±**ï¼š`event_handlers.on_stream_chat()` åªå°†å½“å‰æ¶ˆæ¯ä¼ é€’ç»™Agentï¼Œæ²¡æœ‰ä¼ é€’å®Œæ•´çš„å¯¹è¯å†å²
2. **è®°å¿†ç³»ç»Ÿå¤±æ•ˆ**ï¼šAgentæ¯æ¬¡æ‰§è¡Œæ—¶æ— æ³•è·å¾—å®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼Œå¯¼è‡´è®°å¿†æ£€ç´¢æ•ˆæœä¸ä½³
3. **æ— è¿ç»­æ€§å¯¹è¯**ï¼šæ¯æ¬¡å¯¹è¯éƒ½åƒæ˜¯å…¨æ–°å¼€å§‹ï¼ŒAgentæ— æ³•å¼•ç”¨ä¹‹å‰çš„å¯¹è¯å†…å®¹

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤äº‹ä»¶å¤„ç†å™¨ (`src/web/handlers/event_handlers.py`)

**ä¸»è¦æ”¹åŠ¨**ï¼š
- åœ¨ `on_stream_chat()` æ–¹æ³•ä¸­æ·»åŠ å†å²å¯¹è¯è½¬æ¢é€»è¾‘
- å°†Gradioçš„historyæ ¼å¼è½¬æ¢ä¸ºæ ‡å‡†çš„Messageå¯¹è±¡åˆ—è¡¨
- æ„å»ºåŒ…å«å®Œæ•´å¯¹è¯å†å²çš„ä¸Šä¸‹æ–‡å¹¶ä¼ é€’ç»™Agent
- æ·»åŠ å¯¹è¯å®Œæˆåçš„è®°å¿†ä¿å­˜é€»è¾‘

**å…³é”®ä»£ç æ®µ**ï¼š
```python
# å°†gradioçš„historyæ ¼å¼è½¬æ¢ä¸ºMessageå¯¹è±¡åˆ—è¡¨
conversation_messages = []
for item in new_history:
    if item["role"] == "user":
        conversation_messages.append(Message(
            role=MessageRole.USER,
            content=item["content"]
        ))
    elif item["role"] == "assistant" and item["content"].strip():
        conversation_messages.append(Message(
            role=MessageRole.ASSISTANT,
            content=item["content"]
        ))

# æ„å»ºåŒ…å«å†å²çš„ä¸Šä¸‹æ–‡
context_with_history = {
    "conversation_history": conversation_messages,
    "preserve_history": True
}

# ä¼ é€’å®Œæ•´ä¸Šä¸‹æ–‡ç»™Agent
async for chunk in self.app.current_agent.stream_run(message, context_with_history):
```

### 2. ä¿®å¤Agentå¤„ç†é€»è¾‘ (`src/agents/react_agent.py`)

**ä¸»è¦æ”¹åŠ¨**ï¼š
- ä¿®æ”¹ `stream_run()` å’Œ `run()` æ–¹æ³•ä»¥å¤„ç†ä¼ å…¥çš„å¯¹è¯å†å²
- æ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­æ˜¯å¦åŒ…å« `conversation_history` å’Œ `preserve_history` æ ‡å¿—
- ä½¿ç”¨å®Œæ•´çš„æ¶ˆæ¯å†å²è€Œä¸æ˜¯ä»…å½“å‰æ¶ˆæ¯åˆ›å»ºAgentContext
- é˜²æ­¢é‡å¤ä¿å­˜è®°å¿†ï¼ˆæµå¼å’Œéæµå¼æ¨¡å¼çš„åè°ƒï¼‰

**å…³é”®ä»£ç æ®µ**ï¼š
```python
# å¤„ç†ä¼ å…¥çš„å¯¹è¯å†å²
messages = []
if context and context.get("conversation_history") and context.get("preserve_history"):
    # ä½¿ç”¨å®Œæ•´çš„å¯¹è¯å†å²
    messages = context["conversation_history"].copy()
else:
    # å›é€€åˆ°ä»…ä½¿ç”¨å½“å‰æŸ¥è¯¢
    messages = [Message(role=MessageRole.USER, content=query)]

# åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡ - ä½¿ç”¨å®Œæ•´çš„æ¶ˆæ¯å†å²
agent_context = AgentContext(
    task_id=task_id,
    agent_type=self.agent_type,
    available_tools=available_tools,
    messages=messages,  # ä½¿ç”¨å®Œæ•´çš„æ¶ˆæ¯å†å²
    variables={...}
)
```

### 3. æ›´æ–°æ¬¢è¿ä¿¡æ¯ (`src/web/app.py`)

**ä¸»è¦æ”¹åŠ¨**ï¼š
- åœ¨æ¬¢è¿æ¶ˆæ¯ä¸­æ·»åŠ è®°å¿†ç³»ç»ŸåŠŸèƒ½è¯´æ˜
- å‘ŠçŸ¥ç”¨æˆ·å†å²è®°å½•å’Œè®°å¿†åŠŸèƒ½å·²å¯ç”¨

## ä¿®å¤æ•ˆæœ

### âœ… è§£å†³çš„é—®é¢˜

1. **æ¢å¤å†å²ä¸Šä¸‹æ–‡**ï¼šAgentç°åœ¨èƒ½å¤Ÿæ¥æ”¶å’Œå¤„ç†å®Œæ•´çš„å¯¹è¯å†å²
2. **è®°å¿†ç³»ç»Ÿæ­£å¸¸å·¥ä½œ**ï¼šçŸ­æœŸè®°å¿†ã€é•¿æœŸè®°å¿†ã€è‡ªåŠ¨å‹ç¼©åŠŸèƒ½æ­£å¸¸
3. **è¿ç»­æ€§å¯¹è¯**ï¼šAgentèƒ½å¤Ÿå¼•ç”¨ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œç»´æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
4. **æµå¼å’Œéæµå¼ä¸€è‡´æ€§**ï¼šä¸¤ç§æ¨¡å¼ä¸‹éƒ½èƒ½æ­£ç¡®å¤„ç†å†å²è®°å½•

### ğŸ”§ æŠ€æœ¯æ”¹è¿›

1. **æ•°æ®æµå®Œæ•´æ€§**ï¼šä»ç•Œé¢åˆ°Agentçš„å®Œæ•´æ•°æ®ä¼ é€’é“¾è·¯
2. **è®°å¿†ç®¡ç†ä¼˜åŒ–**ï¼šé¿å…é‡å¤ä¿å­˜ï¼Œåè°ƒä¸åŒæ‰§è¡Œæ¨¡å¼
3. **é”™è¯¯å¤„ç†å¢å¼º**ï¼šæ·»åŠ äº†æ›´å¤šçš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
4. **å‘åå…¼å®¹**ï¼šä¿æŒå¯¹åŸæœ‰APIçš„å…¼å®¹æ€§

## æµ‹è¯•éªŒè¯

åˆ›å»ºäº† `test_history_fix.py` æµ‹è¯•è„šæœ¬æ¥éªŒè¯ï¼š
1. å¤šè½®å¯¹è¯çš„è¿ç»­æ€§
2. è®°å¿†ç³»ç»Ÿçš„çŠ¶æ€å’Œç»Ÿè®¡
3. æµå¼å’Œéæµå¼æ¨¡å¼çš„ä¸€è‡´æ€§

## ä½¿ç”¨å»ºè®®

1. **é‡å¯åº”ç”¨**ï¼šä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯Gradioåº”ç”¨ä»¥ç”Ÿæ•ˆ
2. **æµ‹è¯•å¯¹è¯**ï¼šè¿›è¡Œå¤šè½®å¯¹è¯æµ‹è¯•ï¼ŒéªŒè¯Agentæ˜¯å¦èƒ½è®°ä½ä¹‹å‰çš„å†…å®¹
3. **è®°å¿†ç›‘æ§**ï¼šä½¿ç”¨è®°å¿†ç®¡ç†é¢æ¿ç›‘æ§è®°å¿†ç³»ç»ŸçŠ¶æ€
4. **æ¸…ç†æµ‹è¯•**ï¼šå¯ä»¥ä½¿ç”¨æ¸…ç©ºè®°å¿†åŠŸèƒ½é‡ç½®æµ‹è¯•ç¯å¢ƒ

## ç›¸å…³æ–‡ä»¶

- `src/web/handlers/event_handlers.py` - ä¸»è¦ä¿®å¤æ–‡ä»¶
- `src/agents/react_agent.py` - Agenté€»è¾‘ä¿®å¤
- `src/web/app.py` - ç•Œé¢ä¿¡æ¯æ›´æ–°
- `test_history_fix.py` - æµ‹è¯•éªŒè¯è„šæœ¬ 