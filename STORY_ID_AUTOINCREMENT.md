# 故事ID自增功能实现

## 问题背景

在原有的故事生成系统中，故事ID采用`STORY_XXX`格式，由LLM根据查询到的最大ID递增生成。这导致了以下问题：

1. 当多用户或多角色并行生成故事时，可能产生ID冲突
2. 故事ID生成依赖于LLM的准确性，如果LLM出错可能导致ID不连续或重复
3. 重复生成故事时容易覆盖已有数据

## 解决方案

我们对故事ID生成机制进行了重构，采用以下策略：

1. 在剧情生成阶段，使用临时ID格式：`TEMP_XXX`
2. 在数据库保存阶段：
   - 利用SQLite的`AUTOINCREMENT`特性自动生成唯一ID
   - 基于自增ID创建真实故事ID：`STORY_XXXXX`
   - 更新所有相关小节ID，保持引用关系
3. 将新ID映射回原始数据结构，确保数据一致性

## 实现细节

### 1. PlotGenerationNode修改

- 移除原有的最大ID查询和计算逻辑
- 修改提示词，指导LLM生成临时ID格式
- 小节ID相应改为临时格式

### 2. StoryManager修改

- 使用数据库自增ID作为真实ID的基础
- 在`save_story_data`方法中，创建ID映射机制
- 保存数据时，同步更新所有相关引用

### 3. 优势

- 保证故事ID全局唯一，避免覆盖
- 支持多用户/多角色并行生成
- 移除对LLM准确解析现有ID的依赖
- 保持数据一致性和引用完整性

## 使用说明

该修改对现有功能是透明的，不需要用户进行额外操作。系统会自动处理ID的生成和转换过程。 